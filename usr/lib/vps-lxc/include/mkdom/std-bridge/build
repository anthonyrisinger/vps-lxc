#!/bin/bash

vps_mkdom_build () {

    # adding to the NETWORK and CGROUP arrays should be done in a
    # prebuild file.  DO NOT simply add things to the base config
    # cat command... add additional NETWORKs and CGROUPs to the respective
    # array so they are properly written out the to id file in post_main,
    # and can be used in the future or for validation etc.  this file
    # probably never needs to be edited; edit premain/postmain instead 
    # if possible

    local x err=0

    # write out the base config
    cat <<EOF > ${VPS_DEF}/exec/sys/${VPS_MKDOM_TARGET}.conf || ((err++))
# generated by ${VPS_COMMAND}
# $(date)
lxc.rootfs=${VPS_DOM}/${VPS_MKDOM_TARGET}/rootfs
lxc.mount=${VPS_DOM}/${VPS_MKDOM_TARGET}/fstab
lxc.utsname=${VPS_MKDOM_HOSTNAME}
lxc.tty=${VPS_MKDOM_TTY}
lxc.pts=${VPS_MKDOM_DEVPTS}
EOF

    # add the network definitions
    for x in "${VPS_MKDOM_NETWORK[@]}"; do
        { echo "${x}" | tr , "\n" | sed -e "s/^/lxc.network./g" >> \
            ${VPS_DEF}/exec/sys/${VPS_MKDOM_TARGET}.conf; } || ((err++))
    done

    # add the cgroup definitions
    for x in "${VPS_MKDOM_CGROUP[@]}"; do
        { echo "${x}" | sed -e "s/^/lxc.cgroup./g" >> \
            ${VPS_DEF}/exec/sys/${VPS_MKDOM_TARGET}.conf; } || ((err++))
    done

    # write out the fstab
    cat <<EOF > ${VPS_DEF}/mnt/${VPS_MKDOM_TARGET}.conf || ((err++))
none ${VPS_DOM}/${VPS_MKDOM_TARGET}/rootfs/proc    proc   defaults 0 0
none ${VPS_DOM}/${VPS_MKDOM_TARGET}/rootfs/sys     sysfs  defaults 0 0
none ${VPS_DOM}/${VPS_MKDOM_TARGET}/rootfs/dev/shm tmpfs  defaults 0 0
EOF

    [ ${err} -gt 0 ] && \
        vps_exception ${LINENO} fatal "errors writing out domain config and mount files" ${FUNCNAME}
    return 0

}
